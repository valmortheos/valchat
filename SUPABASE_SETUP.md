# Panduan Konfigurasi Database & Supabase (Auth Biasa)

Panduan ini diperbarui untuk menggunakan autentikasi **Email & Password** standar sesuai permintaan.

## 1. Setup Auth (WAJIB)

Agar login/register berfungsi lancar tanpa verifikasi email yang ribet:

1.  Masuk ke Supabase Dashboard.
2.  Pilih Project Anda.
3.  Buka menu **Authentication** -> **Providers**.
4.  Pilih **Email**.
5.  Pastikan **Enable Email provider** aktif.
6.  **PENTING**: Matikan opsi **Confirm email** (Nonaktifkan) agar user bisa langsung login setelah daftar tanpa perlu buka inbox email.
7.  Simpan.

## 2. Setup Database (Copy & Paste ke SQL Editor Supabase)

Jalankan script ini di menu **SQL Editor**.

```sql
-- 1. Bersihkan Trigger Lama (Penyebab Error)
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user;

-- 2. Buat/Pastikan Tabel Profiles Ada
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  updated_at TIMESTAMP WITH TIME ZONE,
  username TEXT UNIQUE,
  full_name TEXT,
  avatar_url TEXT,
  bio TEXT,
  email TEXT,
  last_seen TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 3. Reset Permission & RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Public profiles are viewable by everyone." ON public.profiles;
DROP POLICY IF EXISTS "Users can insert their own profile." ON public.profiles;
DROP POLICY IF EXISTS "Users can update own profile." ON public.profiles;

CREATE POLICY "Public profiles are viewable by everyone." 
  ON public.profiles FOR SELECT USING (true);

-- Izinkan INSERT manual dari aplikasi (untuk inisialisasi user baru)
CREATE POLICY "Users can insert their own profile." 
  ON public.profiles FOR INSERT 
  WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile." 
  ON public.profiles FOR UPDATE USING (auth.uid() = id);

-- 4. Tabel Pesan (Messages)
CREATE TABLE IF NOT EXISTS public.messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  content TEXT,
  user_id UUID REFERENCES public.profiles(id),
  user_email TEXT,
  user_avatar TEXT,
  receiver_id UUID REFERENCES public.profiles(id),
  room_id TEXT NOT NULL,
  file_url TEXT,
  file_type TEXT,
  is_deleted BOOLEAN DEFAULT false
);

ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Messages are viewable by everyone in the room" ON public.messages;
DROP POLICY IF EXISTS "Users can insert their own messages" ON public.messages;

CREATE POLICY "Messages are viewable by everyone in the room" 
  ON public.messages FOR SELECT 
  USING (
    room_id = 'public' OR 
    auth.uid() = user_id OR 
    auth.uid() = receiver_id
  );

CREATE POLICY "Users can insert their own messages" 
  ON public.messages FOR INSERT 
  WITH CHECK (auth.uid() = user_id);

-- 5. Tabel Pendukung Lainnya
CREATE OR REPLACE VIEW public.last_messages AS
SELECT DISTINCT ON (room_id) *
FROM public.messages
ORDER BY room_id, created_at DESC;

-- Storage
INSERT INTO storage.buckets (id, name, public) VALUES ('avatars', 'avatars', true) ON CONFLICT DO NOTHING;
INSERT INTO storage.buckets (id, name, public) VALUES ('chat-files', 'chat-files', true) ON CONFLICT DO NOTHING;

CREATE POLICY "Avatar Images Public" ON storage.objects FOR SELECT USING (bucket_id = 'avatars');
CREATE POLICY "Avatar Upload Auth" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'avatars' AND auth.role() = 'authenticated');
CREATE POLICY "Chat Files Public" ON storage.objects FOR SELECT USING (bucket_id = 'chat-files');
CREATE POLICY "Chat Files Upload Auth" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'chat-files' AND auth.role() = 'authenticated');
```