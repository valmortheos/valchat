# Panduan Konfigurasi Database & Supabase (Hard Delete Version)

... (SQL sebelumnya tetap sama, tambahkan ini di bagian bawah) ...

-- 9. UPDATE STORIES & STORY VIEWS
-- Tambahkan kolom privacy
ALTER TABLE public.stories ADD COLUMN IF NOT EXISTS privacy TEXT DEFAULT 'public'; -- 'public', 'private'

-- Tabel Story Views (Siapa yang melihat story)
CREATE TABLE IF NOT EXISTS public.story_views (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  story_id BIGINT REFERENCES public.stories(id) ON DELETE CASCADE,
  viewer_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  viewed_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE(story_id, viewer_id) -- Satu user hanya view 1x per story
);

ALTER TABLE public.story_views ENABLE ROW LEVEL SECURITY;

-- Policy: User bisa insert view mereka sendiri
CREATE POLICY "Users can record their own views" 
  ON public.story_views FOR INSERT 
  WITH CHECK (auth.uid() = viewer_id);

-- Policy: Pemilik story bisa melihat siapa yang view
CREATE POLICY "Story owners can see viewers" 
  ON public.story_views FOR SELECT 
  USING (
    EXISTS (
      SELECT 1 FROM public.stories s 
      WHERE s.id = story_views.story_id 
      AND s.user_id = auth.uid()
    )
  );
