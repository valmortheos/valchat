# Panduan Konfigurasi Database & Supabase (Hard Delete Version)

Panduan ini mencakup setup Database Trigger untuk `updated_at` dan tabel Arsip untuk fitur Hard Delete.

## Setup Database (Jalankan di SQL Editor Supabase)

```sql
-- 1. FUNGSI UPDATE TIMESTAMP (Untuk profiles.updated_at)
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 2. Pastikan Tabel Profiles Ada & Pasang Trigger
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  updated_at TIMESTAMP WITH TIME ZONE,
  username TEXT UNIQUE,
  full_name TEXT,
  avatar_url TEXT,
  bio TEXT,
  email TEXT,
  last_seen TIMESTAMP WITH TIME ZONE DEFAULT now()
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Pasang Trigger updated_at pada profiles
DROP TRIGGER IF EXISTS on_profiles_updated ON public.profiles;
CREATE TRIGGER on_profiles_updated
  BEFORE UPDATE ON public.profiles
  FOR EACH ROW EXECUTE PROCEDURE public.handle_updated_at();

-- Policies Profiles
CREATE POLICY "Public profiles are viewable by everyone." 
  ON public.profiles FOR SELECT USING (true);
CREATE POLICY "Users can insert their own profile." 
  ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update own profile." 
  ON public.profiles FOR UPDATE USING (auth.uid() = id);

-- 3. Tabel Pesan (Messages)
CREATE TABLE IF NOT EXISTS public.messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  content TEXT,
  user_id UUID REFERENCES public.profiles(id),
  user_email TEXT,
  user_avatar TEXT,
  receiver_id UUID REFERENCES public.profiles(id),
  room_id TEXT NOT NULL,
  file_url TEXT,
  file_type TEXT
  -- Column is_deleted dihapus/diabaikan karena kita pakai Hard Delete
);

ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;

-- Policies Messages
CREATE POLICY "Messages are viewable by everyone in the room" 
  ON public.messages FOR SELECT 
  USING (room_id = 'public' OR auth.uid() = user_id OR auth.uid() = receiver_id);
CREATE POLICY "Users can insert their own messages" 
  ON public.messages FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can delete their own messages" 
  ON public.messages FOR DELETE USING (auth.uid() = user_id);

-- 4. Tabel Message Archives (INDEPENDEN / TANPA FK)
-- Tabel ini menyimpan pesan yang sudah dihapus permanen dari tabel messages.
-- TIDAK BOLEH ada REFERENCES ke messages(id) agar tidak kena Cascade Delete.
CREATE TABLE IF NOT EXISTS public.message_archives (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  original_message_id BIGINT, -- Hanya simpan angka ID lama
  content TEXT,
  file_url TEXT,
  user_id UUID,
  room_id TEXT,
  archived_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

ALTER TABLE public.message_archives ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can insert archives" 
  ON public.message_archives FOR INSERT WITH CHECK (auth.uid() = user_id);

-- 5. Tabel Read Receipts & Deleted Messages (Deleted for Me)
-- (Setup standar seperti sebelumnya, pastikan FK delete cascade aktif untuk ini)
CREATE TABLE IF NOT EXISTS public.read_receipts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  message_id BIGINT REFERENCES public.messages(id) ON DELETE CASCADE,
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  read_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE(message_id, user_id)
);
ALTER TABLE public.read_receipts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can insert/update their own read receipts" ON public.read_receipts FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Read receipts are viewable by everyone" ON public.read_receipts FOR SELECT USING (true);

CREATE TABLE IF NOT EXISTS public.deleted_messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  message_id BIGINT REFERENCES public.messages(id) ON DELETE CASCADE,
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  deleted_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
ALTER TABLE public.deleted_messages ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can insert their own deleted messages" ON public.deleted_messages FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can view their own deleted messages" ON public.deleted_messages FOR SELECT USING (auth.uid() = user_id);

-- 6. TABEL STORIES (BARU)
CREATE TABLE IF NOT EXISTS public.stories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  media_type TEXT NOT NULL CHECK (media_type IN ('image', 'video', 'text')),
  media_url TEXT, 
  caption TEXT, 
  background_color TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (now() + interval '24 hours')
);

CREATE INDEX IF NOT EXISTS idx_stories_expires_at ON public.stories(expires_at);
ALTER TABLE public.stories ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Stories are viewable by everyone (authenticated)" 
  ON public.stories FOR SELECT 
  USING (auth.role() = 'authenticated' AND expires_at > now());

CREATE POLICY "Users can insert their own stories" 
  ON public.stories FOR INSERT 
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own stories" 
  ON public.stories FOR DELETE 
  USING (auth.uid() = user_id);

-- 7. View Last Messages
CREATE OR REPLACE VIEW public.last_messages AS
SELECT DISTINCT ON (room_id) * FROM public.messages ORDER BY room_id, created_at DESC;

-- 8. Storage Policies
INSERT INTO storage.buckets (id, name, public) VALUES ('avatars', 'avatars', true) ON CONFLICT DO NOTHING;
INSERT INTO storage.buckets (id, name, public) VALUES ('chat-files', 'chat-files', true) ON CONFLICT DO NOTHING;
INSERT INTO storage.buckets (id, name, public) VALUES ('stories', 'stories', true) ON CONFLICT DO NOTHING;

CREATE POLICY "Avatar Images Public" ON storage.objects FOR SELECT USING (bucket_id = 'avatars');
CREATE POLICY "Avatar Upload Auth" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'avatars' AND auth.role() = 'authenticated');
CREATE POLICY "Chat Files Public" ON storage.objects FOR SELECT USING (bucket_id = 'chat-files');
CREATE POLICY "Chat Files Upload Auth" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'chat-files' AND auth.role() = 'authenticated');
CREATE POLICY "Chat Files Delete Auth" ON storage.objects FOR DELETE USING (bucket_id = 'chat-files' AND auth.role() = 'authenticated');

-- Stories Bucket Policy
CREATE POLICY "Stories Media Public" ON storage.objects FOR SELECT USING (bucket_id = 'stories');
CREATE POLICY "Stories Media Upload Auth" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'stories' AND auth.role() = 'authenticated');
CREATE POLICY "Stories Media Delete Auth" ON storage.objects FOR DELETE USING (bucket_id = 'stories' AND auth.role() = 'authenticated');
```